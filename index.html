<!doctype html>
<html lang="nb">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Slide Editor</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#1e1e1e;--panel:#252526;--p2:#2d2d30;--border:#3e3e42;
  --text:#cccccc;--dim:#6e7681;--accent:#0078d4;--ah:#106ebe;
  --danger:#f44747;--r:5px;
}
body{background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,sans-serif;font-size:13px;height:100vh;display:flex;flex-direction:column;overflow:hidden;user-select:none;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}

/* TOPBAR */
.topbar{height:36px;background:#323233;border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 10px;gap:6px;flex-shrink:0}
.tb-title{font-size:11px;font-weight:600;letter-spacing:.08em;color:var(--dim);text-transform:uppercase}
.tb-badge{font-size:10px;background:var(--accent);color:#fff;padding:1px 7px;border-radius:10px}
.tb-sep{width:1px;height:18px;background:var(--border);margin:0 2px}
.tb-space{flex:1}
.tb-btn{height:26px;padding:0 10px;background:var(--p2);color:var(--text);border:1px solid var(--border);border-radius:var(--r);font-size:12px;cursor:pointer;display:flex;align-items:center;gap:5px;transition:background .12s,border-color .12s;white-space:nowrap;position:relative;overflow:hidden}
.tb-btn:hover{background:#3e3e42;border-color:#555}
.tb-btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
.tb-btn.primary:hover{background:var(--ah);border-color:var(--ah)}
.tb-btn input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%}

/* LAYOUT */
.editor{flex:1;display:grid;grid-template-columns:220px 1fr 272px;min-height:0}

/* LEFT PANEL */
.panel-slides{background:var(--panel);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
.ph{padding:10px 10px 8px;border-bottom:1px solid var(--border);flex-shrink:0}
.plabel{font-size:10px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--dim);margin-bottom:7px}
.btn-ny{width:100%;height:28px;background:var(--p2);color:var(--text);border:1px solid var(--border);border-radius:var(--r);font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:5px;transition:background .12s}
.btn-ny:hover{background:#3e3e42}
.slide-liste{flex:1;overflow-y:auto;padding:6px;display:flex;flex-direction:column;gap:4px}
.slide-liste::-webkit-scrollbar{width:6px}
.slide-liste::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* SLIDE CARDS */
.sk{border-radius:var(--r);border:1.5px solid transparent;cursor:pointer;overflow:hidden;transition:border-color .12s}
.sk:hover{border-color:#555}
.sk.aktiv{border-color:var(--accent)}
.sk-thumb{width:100%;aspect-ratio:16/9;position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:8px;overflow:hidden}
.sk-img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:.45}
.sk-overlay{position:relative;z-index:1;text-align:center;pointer-events:none}
.sk-t{font-size:11px;font-weight:600;color:#fff;line-height:1.3;text-shadow:0 1px 4px rgba(0,0,0,.7);overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
.sk-b{font-size:8px;color:rgba(255,255,255,.55);margin-top:2px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;max-width:160px}
.sk-foot{background:rgba(0,0,0,.35);padding:3px 6px;display:flex;align-items:center;gap:2px}
.sk-nr{font-size:10px;color:rgba(255,255,255,.4);flex:1}
.sk-acts{display:flex;gap:1px}
.bik{width:20px;height:20px;background:none;border:none;color:rgba(255,255,255,.4);cursor:pointer;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:11px;transition:background .1s,color .1s}
.bik:hover{background:rgba(255,255,255,.1);color:#fff}
.bik.slett:hover{color:var(--danger)}

/* SUB-SLIDES */
.sk-sub-wrap{padding-left:14px;position:relative;display:flex;flex-direction:column;gap:2px;margin-top:2px}
.sk-sub-wrap::before{content:'';position:absolute;left:7px;top:4px;bottom:4px;width:1px;background:var(--border)}
.sk-add-sub{margin-top:3px;height:22px;background:none;border:1px dashed var(--border);border-radius:var(--r);color:var(--dim);font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:4px;transition:border-color .12s,color .12s;width:100%}
.sk-add-sub:hover{border-color:var(--accent);color:var(--accent)}

/* CENTER PANEL */
.panel-center{background:#181818;display:flex;flex-direction:column;overflow:hidden;position:relative}
.center-bar{height:32px;background:var(--panel);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 10px;gap:8px;flex-shrink:0}
.center-bar-label{font-size:10px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--dim)}
.center-bar-space{flex:1}
.nav-btns{display:flex;gap:3px}
.nav-btn{width:24px;height:22px;background:var(--p2);border:1px solid var(--border);border-radius:var(--r);color:var(--text);font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .1s}
.nav-btn:hover{background:#3e3e42}
.slide-counter{font-size:11px;color:var(--dim)}
.drop-overlay{display:none;position:absolute;inset:32px 0 0;background:rgba(0,120,212,.15);border:2px dashed var(--accent);z-index:100;align-items:center;justify-content:center;font-size:18px;font-weight:600;color:var(--accent);pointer-events:none}
.drop-overlay.vis{display:flex}
#preview-iframe{flex:1;width:100%;border:none;display:block}

/* RIGHT PANEL */
.panel-egenskaper{background:var(--panel);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
.eg-scroll{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:12px}
.eg-scroll::-webkit-scrollbar{width:6px}
.eg-scroll::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
.sek-tittel{font-size:10px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--dim);padding-bottom:6px;border-bottom:1px solid var(--border)}
.fg{display:flex;flex-direction:column;gap:5px}
.fl{font-size:10px;font-weight:600;letter-spacing:.06em;text-transform:uppercase;color:var(--dim)}
.fls{font-weight:400;text-transform:none;letter-spacing:0}
.fi{background:var(--p2);border:1px solid var(--border);border-radius:var(--r);color:var(--text);font-size:13px;padding:6px 8px;width:100%;outline:none;transition:border-color .12s;font-family:inherit;resize:vertical}
.fi:focus{border-color:var(--accent)}
.farge-rad{display:flex;gap:6px;align-items:center}
.fp{width:36px;height:32px;border-radius:var(--r);border:1px solid var(--border);padding:2px;background:var(--p2);cursor:pointer;flex-shrink:0}
.fhex{flex:1;background:var(--p2);border:1px solid var(--border);border-radius:var(--r);color:var(--text);font-size:12px;font-family:'Cascadia Code','Fira Code',monospace;padding:6px 8px;outline:none;transition:border-color .12s}
.fhex:focus{border-color:var(--accent)}
.media-tabs{display:flex;gap:2px;margin-bottom:6px}
.mt{flex:1;height:26px;background:var(--p2);border:1px solid var(--border);border-radius:var(--r);font-size:11px;color:var(--dim);cursor:pointer;transition:all .12s}
.mt.aktiv{background:var(--accent);border-color:var(--accent);color:#fff}
.fu-wrap{position:relative}
.fu-btn{width:100%;height:32px;background:var(--p2);border:1px dashed var(--border);border-radius:var(--r);color:var(--dim);font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:5px;transition:border-color .12s,color .12s;position:relative}
.fu-btn:hover{border-color:var(--accent);color:var(--text)}
.fu-btn input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%}
.mprev{margin-top:6px;display:flex;align-items:flex-start;gap:8px}
.mprev img,.mprev video{max-width:100%;max-height:90px;border-radius:4px;border:1px solid var(--border);object-fit:cover}
.btn-fjern{background:none;border:none;color:var(--dim);cursor:pointer;font-size:14px;transition:color .1s;padding:2px;flex-shrink:0}
.btn-fjern:hover{color:var(--danger)}
.divider{height:1px;background:var(--border)}
.pos-rad{display:flex;gap:6px}
.pos-felt{flex:1;display:flex;flex-direction:column;gap:3px}
.pos-label{font-size:10px;color:var(--dim)}
.pos-inp{background:var(--p2);border:1px solid var(--border);border-radius:var(--r);color:var(--text);font-size:12px;font-family:monospace;padding:4px 6px;width:100%;outline:none;transition:border-color .12s}
.pos-inp:focus{border-color:var(--accent)}
.eg-footer{padding:10px 12px;border-top:1px solid var(--border);flex-shrink:0}
.btn-eks{width:100%;height:32px;background:var(--accent);color:#fff;border:none;border-radius:var(--r);font-size:13px;font-weight:500;cursor:pointer;transition:background .15s;display:flex;align-items:center;justify-content:center;gap:6px}
.btn-eks:hover{background:var(--ah)}
.ingen{display:flex;align-items:center;justify-content:center;color:var(--dim);font-size:12px;text-align:center;line-height:1.7;padding:20px;min-height:100px}
.sub-badge{font-size:9px;background:rgba(0,120,212,.25);color:#60b4f7;border-radius:3px;padding:1px 5px;margin-left:4px;letter-spacing:.04em}
</style>
</head>
<body>

<div class="topbar">
  <span class="tb-title">Slide Editor</span>
  <span class="tb-badge">Reveal.js</span>
  <div class="tb-sep"></div>
  <div class="tb-btn" style="background:#1a7f37;border-color:#1a7f37;color:#fff">
    ↑ Importer HTML
    <input type="file" accept=".html" onchange="importerHTML(this.files[0])">
  </div>
  <button class="tb-btn" onclick="nullstill()" style="color:var(--danger);border-color:var(--danger)">↺ Nullstill</button>
  <div class="tb-space"></div>
  <label style="display:flex;align-items:center;gap:5px;font-size:12px;color:var(--dim);cursor:pointer;user-select:none">
    <input type="checkbox" id="cb-fri-nav" onchange="toggleFriNav(this.checked)" style="accent-color:var(--accent);cursor:pointer">
    Fri navigasjon
  </label>
  <div class="tb-sep"></div>
  <button class="tb-btn primary" onclick="eksporter()">↓ Eksporter HTML</button>
</div>

<div class="editor">

  <!-- LEFT -->
  <aside class="panel-slides">
    <div class="ph">
      <div class="plabel">Slides</div>
      <button class="btn-ny" onclick="nySlide()">+ Ny slide</button>
    </div>
    <div class="slide-liste" id="slide-liste"></div>
  </aside>

  <!-- CENTER -->
  <main class="panel-center"
    ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event)">
    <div class="center-bar">
      <span class="center-bar-label" id="center-label">Slide 1</span>
      <div class="center-bar-space"></div>
      <span class="slide-counter" id="slide-counter">1 / 1</span>
      <div class="nav-btns">
        <button class="nav-btn" onclick="navSlide(-1)" title="Forrige">←</button>
        <button class="nav-btn" onclick="navSlide(1)" title="Neste">→</button>
      </div>
    </div>
    <div class="drop-overlay" id="drop-overlay">Slipp bilde eller video her</div>
    <iframe id="preview-iframe" allow="autoplay; fullscreen"></iframe>
  </main>

  <!-- RIGHT -->
  <aside class="panel-egenskaper">
    <div class="eg-scroll" id="eg-innhold">
      <div class="ingen">Velg en slide</div>
    </div>
    <div class="eg-footer">
      <button class="btn-eks" onclick="eksporter()">↓ Eksporter presentasjon.html</button>
    </div>
  </aside>

</div>

<script>
// ── DATA ──────────────────────────────────────────
const STORAGE_KEY = 'slide-editor-v1';

function standardSlides() {
  return [
    { id:1, tittel:'Tittel på presentasjonen', tekst:'Undertittel eller ingress', bg:'#1a1a2e', notater:'Åpningsslide – si hei.', fragments:'', bilde:null, video:null, htmlRaw:null, undersider:[] },
    { id:2, tittel:'Neste punkt', tekst:'Klikk på en slide for å redigere', bg:'#16213e', notater:'', fragments:'Punkt én\nPunkt to\nPunkt tre', bilde:null, video:null, htmlRaw:null, undersider:[] },
  ];
}

let neste_id = 3;
let slides = standardSlides();
let aktivId = 1;
let presentationStyles = '';
let innstillinger = { friNavigasjon: false };

// ── STORAGE ───────────────────────────────────────
function lagreTilStorage() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify({ slides, aktivId, neste_id, presentationStyles, innstillinger }));
  } catch(e) {}
}

function lastFraStorage() {
  try {
    const data = JSON.parse(localStorage.getItem(STORAGE_KEY));
    if (!data || !Array.isArray(data.slides) || !data.slides.length) return false;
    slides = data.slides;
    aktivId = data.aktivId || data.slides[0].id;
    neste_id = data.neste_id || (Math.max(...data.slides.map(s => s.id)) + 1);
    presentationStyles = data.presentationStyles || '';
    innstillinger = data.innstillinger || { friNavigasjon: false };
    return true;
  } catch(e) { return false; }
}

function nullstill() {
  if (!confirm('Er du sikker? Alle slides slettes og du starter på nytt.')) return;
  slides = standardSlides();
  neste_id = 3;
  aktivId = 1;
  presentationStyles = '';
  innstillinger = { friNavigasjon: false };
  document.getElementById('cb-fri-nav').checked = false;
  localStorage.removeItem(STORAGE_KEY);
  renderListe(); renderEgenskaper(); oppdaterPreview();
}

// ── HELPERS ───────────────────────────────────────
function finnSlide(id) {
  for (const s of slides) {
    if (s.id === id) return s;
    for (const u of (s.undersider || [])) {
      if (u.id === id) return u;
    }
  }
  return null;
}
function aktivSlide() { return finnSlide(aktivId); }

function finnParent(id) {
  for (const s of slides) {
    for (const u of (s.undersider || [])) {
      if (u.id === id) return s;
    }
  }
  return null;
}

function getSlideIndices(id) {
  for (let h = 0; h < slides.length; h++) {
    if (slides[h].id === id) return { h, v: 0 };
    const subs = slides[h].undersider || [];
    for (let v = 0; v < subs.length; v++) {
      if (subs[v].id === id) return { h, v: v + 1 };
    }
  }
  return { h: 0, v: 0 };
}

function flatListe() {
  const flat = [];
  for (const s of slides) {
    flat.push(s.id);
    for (const u of (s.undersider || [])) flat.push(u.id);
  }
  return flat;
}

// ── RENDER LISTE ──────────────────────────────────
function renderListe() {
  const el = document.getElementById('slide-liste');
  el.innerHTML = '';

  slides.forEach((s, i) => {
    // Hovedslide
    const d = document.createElement('div');
    d.className = 'sk' + (s.id === aktivId ? ' aktiv' : '');
    d.onclick = () => velgSlide(s.id);
    d.innerHTML = `
      <div class="sk-thumb" style="background:${s.bg}">
        ${s.bilde ? `<img class="sk-img" src="${s.bilde.dataUrl}">` : ''}
        <div class="sk-overlay">
          <div class="sk-t">${escH(s.tittel)||'(tom)'}</div>
          <div class="sk-b">${escH(s.tekst)}</div>
        </div>
      </div>
      <div class="sk-foot">
        <span class="sk-nr">${i+1}</span>
        <div class="sk-acts">
          <button class="bik" title="Opp" onclick="event.stopPropagation();flyttSlide(${s.id},-1)">↑</button>
          <button class="bik" title="Ned" onclick="event.stopPropagation();flyttSlide(${s.id},1)">↓</button>
          <button class="bik slett" title="Slett" onclick="event.stopPropagation();slettSlide(${s.id})">✕</button>
        </div>
      </div>`;
    el.appendChild(d);

    // Undersider
    const subs = s.undersider || [];
    if (subs.length > 0) {
      const wrap = document.createElement('div');
      wrap.className = 'sk-sub-wrap';
      subs.forEach((u, j) => {
        const ud = document.createElement('div');
        ud.className = 'sk' + (u.id === aktivId ? ' aktiv' : '');
        ud.onclick = () => velgSlide(u.id);
        ud.innerHTML = `
          <div class="sk-thumb" style="background:${u.bg}">
            ${u.bilde ? `<img class="sk-img" src="${u.bilde.dataUrl}">` : ''}
            <div class="sk-overlay">
              <div class="sk-t">${escH(u.tittel)||'(tom)'}</div>
            </div>
          </div>
          <div class="sk-foot">
            <span class="sk-nr">${i+1}.${j+1}</span>
            <div class="sk-acts">
              <button class="bik" title="Opp" onclick="event.stopPropagation();flyttUnderSlide(${s.id},${u.id},-1)">↑</button>
              <button class="bik" title="Ned" onclick="event.stopPropagation();flyttUnderSlide(${s.id},${u.id},1)">↓</button>
              <button class="bik slett" title="Slett" onclick="event.stopPropagation();slettSlide(${u.id})">✕</button>
            </div>
          </div>`;
        wrap.appendChild(ud);
      });
      el.appendChild(wrap);
    }

    // Legg til underslide-knapp
    const addBtn = document.createElement('button');
    addBtn.className = 'sk-add-sub';
    addBtn.innerHTML = '↓ Ny underslide';
    addBtn.onclick = (e) => { e.stopPropagation(); nyUnderSlide(s.id); };
    el.appendChild(addBtn);
  });

  const { h, v } = getSlideIndices(aktivId);
  document.getElementById('slide-counter').textContent = `${h+1} / ${slides.length}`;
  document.getElementById('center-label').textContent = v > 0 ? `Slide ${h+1}.${v}` : `Slide ${h+1}`;
}

// ── RENDER EGENSKAPER ─────────────────────────────
function renderEgenskaper() {
  const s = aktivSlide();
  const el = document.getElementById('eg-innhold');
  if (!s) { el.innerHTML = '<div class="ingen">Velg en slide</div>'; return; }

  const erSub = !!finnParent(s.id);
  const vUrl = !s.video || s.video.type==='url' ? 'aktiv' : '';
  const vFil = s.video && s.video.type==='fil' ? 'aktiv' : '';

  const bildePos = s.bilde ? `
    <div class="fg">
      <label class="fl">Posisjon og størrelse</label>
      <div class="pos-rad">
        <div class="pos-felt"><div class="pos-label">X %</div><input class="pos-inp" type="number" min="0" max="100" value="${Math.round(s.bilde.x*100)}" oninput="oppdaterBildePos('x',+this.value/100)"></div>
        <div class="pos-felt"><div class="pos-label">Y %</div><input class="pos-inp" type="number" min="0" max="100" value="${Math.round(s.bilde.y*100)}" oninput="oppdaterBildePos('y',+this.value/100)"></div>
        <div class="pos-felt"><div class="pos-label">Bredde %</div><input class="pos-inp" type="number" min="5" max="100" value="${Math.round(s.bilde.w*100)}" oninput="oppdaterBildePos('w',+this.value/100)"></div>
      </div>
      <button style="height:24px;background:none;border:1px solid var(--border);border-radius:var(--r);color:var(--dim);font-size:11px;cursor:pointer;margin-top:2px" onclick="fjernMedia('bilde')">Fjern bilde</button>
    </div>` : '';

  el.innerHTML = `
    <div class="sek-tittel">Innhold ${erSub ? '<span class="sub-badge">↕ underslide</span>' : ''}</div>
    <div class="fg"><label class="fl">Tittel</label>
      <input class="fi" type="text" value="${escA(s.tittel)}" oninput="oppdater('tittel',this.value)"></div>
    <div class="fg"><label class="fl">Brødtekst</label>
      <textarea class="fi" rows="3" oninput="oppdater('tekst',this.value)">${escH(s.tekst)}</textarea></div>
    <div class="fg"><label class="fl">Bakgrunnsfarge</label>
      <div class="farge-rad">
        <input class="fp" type="color" value="${s.bg}" oninput="oppdaterFarge(this.value)">
        <input class="fhex" type="text" value="${s.bg}" maxlength="7" spellcheck="false" oninput="oppdaterFargeHex(this.value)">
      </div></div>
    <div class="divider"></div>
    <div class="sek-tittel">Punktliste (fragments)</div>
    <div class="fg"><label class="fl">Punkter <span class="fls">— én linje per punkt</span></label>
      <textarea class="fi" rows="4" placeholder="Punkt én&#10;Punkt to&#10;Punkt tre" oninput="oppdater('fragments',this.value)">${escH(s.fragments)}</textarea></div>
    <div class="divider"></div>
    <div class="sek-tittel">Bilde</div>
    <div class="fg">
      <div class="fu-wrap"><div class="fu-btn">↑ ${s.bilde ? escH(s.bilde.navn) : 'Velg bildefil…'}
        <input type="file" accept="image/*" onchange="lastOppBilde(this.files[0])"></div></div>
      ${s.bilde ? `<div class="mprev"><img src="${s.bilde.dataUrl}"><button class="btn-fjern" onclick="fjernMedia('bilde')">✕</button></div>` : ''}
      ${bildePos}
    </div>
    <div class="divider"></div>
    <div class="sek-tittel">Video</div>
    <div class="fg">
      <div class="media-tabs">
        <button class="mt ${vUrl}" onclick="byttVideoTab('url')">Lenke / URL</button>
        <button class="mt ${vFil}" onclick="byttVideoTab('fil')">Fil</button>
      </div>
      <div id="video-innhold">${byggVideoInnhold(s)}</div>
    </div>
    <div class="divider"></div>
    <div class="sek-tittel">Speaker notes</div>
    <div class="fg"><label class="fl">Notater <span class="fls">— S-tasten i presentasjon</span></label>
      <textarea class="fi" rows="4" oninput="oppdater('notater',this.value)">${escH(s.notater)}</textarea></div>
    <div class="divider"></div>
    <div class="sek-tittel">Custom HTML ${s.htmlRaw ? '<span style="color:#f97316;font-weight:700">⚠ aktiv</span>' : ''}</div>
    <div class="fg">
      ${s.htmlRaw
        ? '<div style="font-size:10px;color:#f97316;padding:2px 0 4px">Rå HTML er aktiv – strukturerte felt ovenfor ignoreres i preview og eksport.</div>'
        : '<div style="font-size:10px;color:var(--dim);padding:2px 0 4px">Lim inn en komplett &lt;section&gt;…&lt;/section&gt; for å overstyre alle felt.</div>'
      }
      <textarea class="fi" rows="8" style="font-family:monospace;font-size:11px;resize:vertical" placeholder="&lt;section data-background=&quot;#1a1a2e&quot;&gt;&#10;  …&#10;&lt;/section&gt;" oninput="oppdaterRawHtml(this.value)">${escH(s.htmlRaw||'')}</textarea>
      ${s.htmlRaw ? `<button style="height:24px;background:none;border:1px solid var(--border);border-radius:var(--r);color:var(--dim);font-size:11px;cursor:pointer;margin-top:2px" onclick="fjernRawHtml()">↩ Tilbake til strukturert modus</button>` : ''}
    </div>`;
}

function byggVideoInnhold(s) {
  if (!s.video || s.video.type==='url') {
    const v = (s.video && s.video.type==='url') ? escA(s.video.verdi||'') : '';
    return `<input class="fi" type="url" placeholder="YouTube, Vimeo eller direktelenke…" value="${v}" oninput="oppdaterVideoUrl(this.value)">`;
  }
  const harFil = s.video?.dataUrl;
  return `<div class="fu-wrap"><div class="fu-btn">↑ ${harFil ? escH(s.video.navn) : 'Velg videofil…'}
    <input type="file" accept="video/*" onchange="lastOppVideo(this.files[0])"></div></div>
    ${harFil ? `<div class="mprev"><video src="${s.video.dataUrl}"></video><button class="btn-fjern" onclick="fjernMedia('video')">✕</button></div>` : ''}`;
}

// ── OPPDATER ──────────────────────────────────────
function oppdater(felt, verdi) {
  const s = aktivSlide(); if (!s) return;
  s[felt] = verdi;
  renderListe(); oppdaterPreview();
}
function oppdaterFarge(hex) {
  const s = aktivSlide(); if (!s) return;
  s.bg = hex;
  const h = document.querySelector('.fhex'); if (h) h.value = hex;
  renderListe(); oppdaterPreview();
}
function oppdaterFargeHex(hex) {
  if (!/^#[0-9a-fA-F]{6}$/.test(hex)) return;
  const s = aktivSlide(); if (!s) return;
  s.bg = hex;
  const p = document.querySelector('.fp'); if (p) p.value = hex;
  renderListe(); oppdaterPreview();
}
function oppdaterVideoUrl(v) {
  const s = aktivSlide(); if (!s) return;
  s.video = v.trim() ? {type:'url',verdi:v.trim()} : null;
  renderListe(); oppdaterPreview();
}
function oppdaterBildePos(felt, verdi) {
  const s = aktivSlide(); if (!s||!s.bilde) return;
  s.bilde[felt] = verdi;
  oppdaterPreview();
}
function oppdaterRawHtml(verdi) {
  const s = aktivSlide(); if (!s) return;
  const wasRaw = !!s.htmlRaw;
  s.htmlRaw = verdi.trim() || null;
  if (!!s.htmlRaw !== wasRaw) renderEgenskaper();
  oppdaterPreview();
}
function fjernRawHtml() {
  const s = aktivSlide(); if (!s) return;
  s.htmlRaw = null;
  renderEgenskaper(); oppdaterPreview();
}

// ── MEDIA ─────────────────────────────────────────
function lastOppBilde(fil) {
  if (!fil) return;
  const reader = new FileReader();
  reader.onload = e => {
    const s = aktivSlide(); if (!s) return;
    const img = new Image();
    img.onload = () => {
      const ar = img.width / img.height;
      const w = 0.45;
      const h = w / ar / (960/540);
      s.bilde = { dataUrl:e.target.result, navn:fil.name, x:0.05, y:0.1, w, h };
      renderListe(); renderEgenskaper(); oppdaterPreview();
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(fil);
}
function lastOppVideo(fil) {
  if (!fil) return;
  const reader = new FileReader();
  reader.onload = e => {
    const s = aktivSlide(); if (!s) return;
    s.video = {type:'fil', dataUrl:e.target.result, navn:fil.name};
    renderEgenskaper(); oppdaterPreview();
  };
  reader.readAsDataURL(fil);
}
function fjernMedia(type) {
  const s = aktivSlide(); if (!s) return;
  if (type==='bilde') s.bilde=null;
  if (type==='video') s.video=null;
  renderListe(); renderEgenskaper(); oppdaterPreview();
}
function byttVideoTab(type) {
  const s = aktivSlide(); if (!s) return;
  s.video = {type};
  document.querySelectorAll('#eg-innhold .mt').forEach((b,i)=>{b.classList.toggle('aktiv',(i===0&&type==='url')||(i===1&&type==='fil'))});
  document.getElementById('video-innhold').innerHTML = byggVideoInnhold(s);
}

// ── SLIDE ACTIONS ─────────────────────────────────
function velgSlide(id) {
  aktivId = id;
  renderListe(); renderEgenskaper(); oppdaterPreview();
}
function nySlide() {
  const s = {id:neste_id++, tittel:'Ny slide', tekst:'', bg:'#1a1a2e', notater:'', fragments:'', bilde:null, video:null, htmlRaw:null, undersider:[]};
  slides.push(s); aktivId = s.id;
  renderListe(); renderEgenskaper(); oppdaterPreview();
}
function nyUnderSlide(parentId) {
  const parent = slides.find(s => s.id === parentId);
  if (!parent) return;
  parent.undersider = parent.undersider || [];
  const u = {id:neste_id++, tittel:'Ny underslide', tekst:'', bg:parent.bg, notater:'', fragments:'', bilde:null, video:null, htmlRaw:null};
  parent.undersider.push(u);
  aktivId = u.id;
  renderListe(); renderEgenskaper(); oppdaterPreview();
}
function slettSlide(id) {
  const parent = finnParent(id);
  if (parent) {
    parent.undersider = parent.undersider.filter(u => u.id !== id);
    if (aktivId === id) aktivId = parent.id;
    renderListe(); renderEgenskaper(); oppdaterPreview();
    return;
  }
  if (slides.length <= 1) return;
  const idx = slides.findIndex(s => s.id === id);
  slides.splice(idx, 1);
  if (aktivId === id) aktivId = slides[Math.min(idx, slides.length-1)].id;
  renderListe(); renderEgenskaper(); oppdaterPreview();
}
function flyttSlide(id, dir) {
  const idx = slides.findIndex(s=>s.id===id), ny=idx+dir;
  if (ny<0||ny>=slides.length) return;
  [slides[idx],slides[ny]]=[slides[ny],slides[idx]];
  renderListe(); oppdaterPreview();
}
function flyttUnderSlide(parentId, subId, dir) {
  const parent = slides.find(s=>s.id===parentId);
  if (!parent) return;
  const subs = parent.undersider;
  const idx = subs.findIndex(u=>u.id===subId), ny=idx+dir;
  if (ny<0||ny>=subs.length) return;
  [subs[idx],subs[ny]]=[subs[ny],subs[idx]];
  renderListe(); oppdaterPreview();
}
function navSlide(dir) {
  const flat = flatListe();
  const idx = flat.indexOf(aktivId);
  const ny = idx + dir;
  if (ny >= 0 && ny < flat.length) velgSlide(flat[ny]);
}

// ── DRAG & DROP FILER ─────────────────────────────
function onDragOver(e) {
  e.preventDefault();
  document.getElementById('drop-overlay').classList.add('vis');
}
function onDragLeave(e) {
  if (!document.querySelector('.panel-center').contains(e.relatedTarget)) {
    document.getElementById('drop-overlay').classList.remove('vis');
  }
}
function onDrop(e) {
  e.preventDefault();
  document.getElementById('drop-overlay').classList.remove('vis');
  const fil = e.dataTransfer.files[0];
  if (!fil) return;
  if (fil.type.startsWith('image/')) lastOppBilde(fil);
  else if (fil.type.startsWith('video/')) lastOppVideo(fil);
}

// ── BYGG HTML ─────────────────────────────────────
function byggEnkelSection(s, eksport=false) {
  if (s.htmlRaw) {
    // Inject gjeldende bakgrunnsfarge uansett hva som ligger i rå HTML
    let html = s.htmlRaw;
    if (/data-background="[^"]*"/.test(html)) {
      html = html.replace(/data-background="[^"]*"/, `data-background="${escA(s.bg)}"`);
    } else {
      html = html.replace(/^<section/, `<section data-background="${escA(s.bg)}"`);
    }
    return html;
  }
  const frags = (s.fragments||'').split('\n').map(l=>l.trim()).filter(Boolean);
  return `<section data-background="${escA(s.bg)}">
    ${s.tittel?`<h2 style="color:#fff;text-shadow:0 2px 8px rgba(0,0,0,.5);text-transform:none">${escH(s.tittel)}</h2>`:''}
    ${s.tekst?`<p style="color:rgba(255,255,255,.75);margin-top:.5rem">${escH(s.tekst)}</p>`:''}
    ${s.bilde?`<img src="${s.bilde.dataUrl}" style="position:absolute;left:${(s.bilde.x*100).toFixed(1)}%;top:${(s.bilde.y*100).toFixed(1)}%;width:${(s.bilde.w*100).toFixed(1)}%;pointer-events:none">`:''}
    ${s.video?byggVideoHtml(s.video,eksport):''}
    ${frags.length?`<ul style="margin-top:1rem;text-align:left">${frags.map(f=>`<li class="fragment fade-up">${escH(f)}</li>`).join('')}</ul>`:''}
    ${s.notater?`<aside class="notes">${escH(s.notater)}</aside>`:''}
  </section>`;
}

function byggSlideHtml(s, eksport=false) {
  const subs = s.undersider || [];
  if (subs.length > 0) {
    const alle = [s, ...subs].map(u => byggEnkelSection(u, eksport)).join('\n');
    return `<section>\n${alle}\n</section>`;
  }
  return byggEnkelSection(s, eksport);
}

function byggVideoHtml(v, eksport=false) {
  if (!v) return '';
  if (v.type==='url'&&v.verdi) {
    const yt = ytId(v.verdi), vm = vmId(v.verdi);
    if (yt) {
      if (eksport) return `<iframe src="https://www.youtube-nocookie.com/embed/${yt}" width="560" height="315" frameborder="0" allow="autoplay;fullscreen" allowfullscreen style="margin-top:1rem;border-radius:8px;max-width:90%"></iframe>`;
      return `<div style="position:relative;display:inline-block;margin-top:1rem;max-width:90%">
        <img src="https://img.youtube.com/vi/${yt}/hqdefault.jpg" style="width:480px;max-width:100%;border-radius:8px;display:block">
        <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center">
          <div style="width:64px;height:64px;background:rgba(200,0,0,.9);border-radius:50%;display:flex;align-items:center;justify-content:center">
            <div style="width:0;height:0;border-top:16px solid transparent;border-bottom:16px solid transparent;border-left:26px solid #fff;margin-left:5px"></div>
          </div>
        </div>
        <div style="position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,.55);border-radius:0 0 8px 8px;padding:4px 8px;font-size:11px;color:rgba(255,255,255,.7)">YouTube — video spilles i eksportert fil</div>
      </div>`;
    }
    if (vm) {
      if (eksport) return `<iframe src="https://player.vimeo.com/video/${vm}" width="560" height="315" frameborder="0" allowfullscreen style="margin-top:1rem;border-radius:8px;max-width:90%"></iframe>`;
      return `<div style="margin-top:1rem;width:480px;max-width:90%;height:270px;background:#111;border-radius:8px;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px;border:1px solid rgba(255,255,255,.2)">
        <div style="font-size:32px">▶</div>
        <div style="font-size:13px;color:rgba(255,255,255,.7)">Vimeo — video spilles i eksportert fil</div>
      </div>`;
    }
    return `<video src="${escA(v.verdi)}" controls style="max-width:80%;max-height:260px;border-radius:8px;margin-top:1rem"></video>`;
  }
  if (v.type==='fil'&&v.dataUrl) return `<video src="${v.dataUrl}" controls style="max-width:80%;max-height:260px;border-radius:8px;margin-top:1rem"></video>`;
  return '';
}

function ytId(url) { const m=url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/); return m?m[1]:null; }
function vmId(url) { const m=url.match(/vimeo\.com\/(\d+)/); return m?m[1]:null; }

// ── PREVIEW ───────────────────────────────────────
let pvTimeout = null;
function oppdaterPreview() {
  clearTimeout(pvTimeout);
  pvTimeout = setTimeout(() => {
    lagreTilStorage();
    const iframe = document.getElementById('preview-iframe');
    const { h, v } = getSlideIndices(aktivId);
    const html = `<!doctype html><html><head>
      <meta charset="utf-8">
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@5/dist/reveal.css">
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@5/dist/theme/black.css">
      <style>body{margin:0;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.reveal h2,.reveal h3{text-transform:none}${presentationStyles}</style>
    </head><body>
      <div class="reveal"><div class="slides">${slides.map(s=>byggSlideHtml(s,false)).join('')}</div></div>
      <script src="https://cdn.jsdelivr.net/npm/reveal.js@5/dist/reveal.js"><\/script>
      <script src="https://cdn.jsdelivr.net/npm/reveal.js@5/plugin/notes/notes.js"><\/script>
      <script>Reveal.initialize({hash:false,controls:true,progress:false,transition:'slide',navigationMode:'${innstillinger.friNavigasjon?"grid":"default"}',plugins:[RevealNotes]});
      window.addEventListener('message',e=>{if(e.data&&e.data.type==='goto')Reveal.slide(e.data.h,e.data.v||0)});<\/script>
    </body></html>`;
    const blob = new Blob([html], {type:'text/html'});
    const oldUrl = iframe._blobUrl;
    iframe._blobUrl = URL.createObjectURL(blob);
    iframe.src = iframe._blobUrl;
    if (oldUrl) URL.revokeObjectURL(oldUrl);
    iframe.onload = () => setTimeout(()=>{ try{iframe.contentWindow.postMessage({type:'goto',h,v},'*')}catch(e){} }, 700);
  }, 150);
}

// ── IMPORTER HTML ─────────────────────────────────
function importerHTML(fil) {
  if (!fil) return;
  const reader = new FileReader();
  reader.onload = e => {
    const parser = new DOMParser();
    const doc = parser.parseFromString(e.target.result, 'text/html');
    const seksjoner = doc.querySelectorAll('.slides > section');
    if (!seksjoner.length) { alert('Fant ingen slides i filen.'); return; }

    const importert = [];
    seksjoner.forEach((sec, i) => {
      // Sjekk om det er en vertikal gruppe (section > section)
      const subSecs = sec.querySelectorAll(':scope > section');
      if (subSecs.length > 0) {
        // Vertikal gruppe
        const subListe = Array.from(subSecs);
        const first = subListe[0];
        const rest = subListe.slice(1);

        const mainId = neste_id++;
        const parsedMain = parseSection(first, i, mainId);
        parsedMain.undersider = rest.map((s, j) => { const u = parseSection(s, j, neste_id++); delete u.undersider; return u; });
        importert.push(parsedMain);
      } else {
        importert.push({ ...parseSection(sec, i, neste_id++), undersider: [] });
      }
    });

    const styleEls = doc.querySelectorAll('head style');
    const importertStyles = Array.from(styleEls).map(el => el.textContent).join('\n');

    if (confirm(`Importer ${importert.length} slides? Dette erstatter nåværende presentasjon.`)) {
      slides = importert;
      aktivId = slides[0].id;
      presentationStyles = importertStyles;
      renderListe(); renderEgenskaper(); oppdaterPreview();
    }
  };
  reader.readAsText(fil);
}

function parseSection(sec, i, id) {
  const bg = sec.getAttribute('data-background') || '#1a1a2e';
  const h = sec.querySelector('h1,h2,h3');
  const p = sec.querySelector('p');
  const notEl = sec.querySelector('aside.notes');
  const frags = Array.from(sec.querySelectorAll('li.fragment')).map(li=>li.textContent.trim());
  const imgEl = sec.querySelector('img');
  const vidEl = sec.querySelector('video');
  const ifrEl = sec.querySelector('iframe');

  let bilde = null;
  if (imgEl?.src) {
    const style = imgEl.getAttribute('style')||'';
    const lm = style.match(/left:([\d.]+)%/);
    const tm = style.match(/top:([\d.]+)%/);
    const wm = style.match(/width:([\d.]+)%/);
    bilde = { dataUrl:imgEl.src, navn:'importert.jpg', x:lm?+lm[1]/100:0.05, y:tm?+tm[1]/100:0.1, w:wm?+wm[1]/100:0.45, h:0.3 };
  }
  let video = null;
  if (vidEl?.src) video = {type:'url', verdi:vidEl.src};
  else if (ifrEl?.src) video = {type:'url', verdi:ifrEl.src};

  return {
    id,
    tittel: h ? h.textContent.trim() : `Slide ${i+1}`,
    tekst: p ? p.textContent.trim() : '',
    bg: /^#[0-9a-fA-F]{3,8}$/.test(bg) ? bg : '#1a1a2e',
    notater: notEl ? notEl.textContent.trim() : '',
    fragments: frags.join('\n'),
    bilde, video,
    htmlRaw: sec.outerHTML,
    undersider: [],
  };
}

// ── EKSPORTER ─────────────────────────────────────
function eksporter() {
  const html = `<!doctype html>
<html lang="nb">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Presentasjon</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@5/dist/reveal.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@5/dist/theme/black.css">
  <style>body{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.reveal h1,.reveal h2,.reveal h3{text-transform:none}${presentationStyles}</style>
</head>
<body>
  <div class="reveal"><div class="slides">
    ${slides.map(s=>byggSlideHtml(s,true)).join('\n    ')}
  </div></div>
  <script src="https://cdn.jsdelivr.net/npm/reveal.js@5/dist/reveal.js"><\/script>
  <script src="https://cdn.jsdelivr.net/npm/reveal.js@5/plugin/notes/notes.js"><\/script>
  <script>Reveal.initialize({hash:true,transition:'slide',navigationMode:'${innstillinger.friNavigasjon?"grid":"default"}',plugins:[RevealNotes]});<\/script>
</body>
</html>`;
  const url = URL.createObjectURL(new Blob([html],{type:'text/html'}));
  const a = document.createElement('a');
  a.href = url;
  a.download = 'presentasjon.html';
  a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}

// ── INNSTILLINGER ─────────────────────────────────
function toggleFriNav(val) {
  innstillinger.friNavigasjon = val;
  oppdaterPreview();
}

// ── UTILS ─────────────────────────────────────────
function escH(s=''){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
function escA(s=''){return String(s).replace(/"/g,'&quot;').replace(/'/g,'&#39;')}

// ── INIT ──────────────────────────────────────────
if (lastFraStorage()) {
  document.getElementById('cb-fri-nav').checked = innstillinger.friNavigasjon;
}
renderListe(); renderEgenskaper(); oppdaterPreview();
</script>
</body>
</html>
